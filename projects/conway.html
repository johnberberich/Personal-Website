<!DOCTYPE html>
<html>
<head>
<title>Conway's Game of Life</title>
<script type="text/javascript">
var grid;
var width, height;

var ctx;

var isRunning = false;

// Here we have some basic start states.  It's important
// that we add a one-cell, zero-value border around the
// intended grid; this simplifies the update logic.
var blinker = [[0, 0, 0, 0, 0, 0, 0],
			   [0, 0, 0, 0, 0, 0, 0],
			   [0, 0, 0, 1, 0, 0, 0],
			   [0, 0, 0, 1, 0, 0, 0],
			   [0, 0, 0, 1, 0, 0, 0],
			   [0, 0, 0, 0, 0, 0, 0],
			   [0, 0, 0, 0, 0, 0, 0]];

var beacon = [[0, 0, 0, 0, 0, 0, 0, 0],
			  [0, 0, 0, 0, 0, 0, 0, 0],
			  [0, 0, 1, 1, 0, 0, 0, 0],
			  [0, 0, 1, 0, 0, 0, 0, 0],
			  [0, 0, 0, 0, 0, 1, 0, 0],
			  [0, 0, 0, 0, 1, 1, 0, 0],
			  [0, 0, 0, 0, 0, 0, 0, 0],
			  [0, 0, 0, 0, 0, 0, 0, 0]];
			  
var misc = [[0, 0, 0, 0, 0, 0, 0, 0],
			[0, 0, 0, 0, 0, 0, 0, 0],
			[0, 0, 1, 1, 0, 0, 0, 0],
			[0, 0, 1, 0, 0, 0, 0, 0],
			[0, 0, 0, 0, 0, 1, 0, 0],
			[0, 0, 1, 0, 1, 1, 0, 0],
			[0, 0, 0, 0, 0, 0, 0, 0],
			[0, 0, 0, 0, 0, 0, 0, 0]];

var gameInit = function() {
	grid = beacon;
	width = grid.length - 2;
	height = grid[0].length - 2;

	var canvas = document.getElementById('canvas');
	if(canvas.getContext){
		ctx = canvas.getContext('2d');
	}
	
	render();  // Render the initial state.
}
var gameStep = function() {
	update();
	render();
}
var gameLoop = function() {
	if(isRunning) {
		gameStep();
		setTimeout("gameLoop();", 500);
	}
}
var gameToggle = function() {
	isRunning = !isRunning;
	if(isRunning)
		gameLoop();
}
var gameReset = function() {
	gameInit();
}

var render = function() {
	renderTextMode();
	if(ctx)
		renderGfxMode();
}
var renderTextMode = function() {
	var text = '';
	var x, y;
	for(y = 1; y < height+1; y++) {
		for(x = 1; x < width+1; x++) {
			text += grid[y][x] > 0 ? 'X ' : '  ';
		}
		text += '\n';
	}
	document.getElementById('text').innerHTML = text;
}
var pi2 = Math.PI * 2;
var renderGfxMode = function() {
	var r = 25;   // radius of a cell
	var d = r*2;  // and the diameter (for calc purposes)
	var x, y;
	for(y = 0; y < height; y++) {
		for(x = 0; x < width; x++) {
			ctx.beginPath();
			ctx.arc(x*d+r, y*d+r, r, 0, pi2, false);
			if(grid[y+1][x+1] > 0)
				ctx.fill();
			else
				ctx.stroke();
		}
	}
}

var update = function() {
	var x, y;
	var newgrid = new Array();
	newgrid.push([0, 0, 0, 0, 0]);
	for(y = 1; y < height+1; y++) {
		newgrid[y] = new Array();
		newgrid[y].push(0);
		for(x = 1; x < width+1; x++) {
			newgrid[y][x] = isCellAlive(x, y);
		}
		newgrid[y].push(0);
	}
	newgrid.push([0, 0, 0, 0, 0]);
	delete grid;
	grid = newgrid;
}

var isCellAlive = function(x, y) {
	var wasAlive = grid[y][x];
	numLivingNeighbors = countLivingNeighbors(x, y);
	if(wasAlive) {
		if(numLivingNeighbors == 2 || numLivingNeighbors == 3)
			return 1;
		return 0;  // died by under- or over- population
		// dead cell
	}
	if(numLivingNeighbors == 3)
		return 1;  // alive via reproduction
	return 0;
}

var countLivingNeighbors = function(x, y) {
	return grid[y-1][x-1] + grid[y-1][x] + grid[y-1][x+1]
		 + grid[y][x-1]                  + grid[y][x+1]
		 + grid[y+1][x-1] + grid[y+1][x] + grid[y+1][x+1];
}

</script>
<style type="text/css">
	canvas, pre { /* Reset these guys. */
		margin: 0px;
		padding: 0px;
	}
	.gameboard {
		float: left;
		padding: 10px;
		margin-right: 20px;
		border: 1px solid black;
	}
	.gameboard pre {
		width: 150px;
		height: 150px;
		text-align: center;
		/*TODO: worry about vertical alignment later */
		border: 2px solid red;
	}
	.gameboard canvas {
		border: 2px solid blue;
		margin-bottom: -6px;  /* For some reason, the canvas renders with a little bottom margin. */
	}
	#webgl {
		border: 2px solid green;
	}
	#controls {
		float: left;
		overflow: auto;
		width: 100%;
		padding-bottom: 20px;
	}
	#controls button {
		width: 100px;
	}
</style>
</head>
<body onload="gameInit();">
<h1>Conway's Game of Life</h1>
<h2>Rules</h2>
<ol>
	<li>Any live cell with fewer than two live neighbours dies, as if caused by under-population.</li>
	<li>Any live cell with two or three live neighbours lives on to the next generation.</li>
	<li>Any live cell with more than three live neighbours dies, as if by overcrowding.</li>
	<li>Any dead cell with exactly three live neighbours becomes a live cell, as if by reproduction.</li>
</ol>

<h2>The game in action</h2>
<div id="controls">
	<button type="button" onclick="gameStep();">Step</button>
	<button type="button" onclick="gameToggle();">Start/Stop</button>
	<button type="buttom" onclick="gameReset();">Reset</button>
</div>

<div class="gameboard">
	<h3>Text</h3>
	<pre id="text"></pre>
</div>
<div class="gameboard">
	<h3>Canvas</h3>
	<canvas id="canvas" width="150" height="150">
		Your browser doesn't support the <code>&lt;canvas&gt;</code> element.
	</canvas>
</div>
<div class="gameboard">
	<h3>WebGL</h3>
	<canvas id="webgl" width="150" height="150">
		Your browser doesn't support the <code>&lt;canvas&gt;</code> element.
	</canvas>
</div>
</body>
</html>

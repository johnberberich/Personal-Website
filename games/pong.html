<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Pong - Games - John Berberich</title>
	<link rel="stylesheet" href="../css/reset.css">
	<!--link rel="stylesheet" href="../css/style.css"-->
</head>
<body>
	<noscript>
		<div class="alert">
			You need a modern browser and Javascript enabled to play Pong.
		</div>
	</noscript>

	<canvas id="canvas" width="320" height="240" style="border:1px solid #000">
		You need a modern browser and Javascript enabled to play Pong.
	</canvas>
	
	<script>
		function Player(name, keyState) {
			this.name = name;
			this.keyState = keyState;
			this.top = 0;
			this.height = 50;
			this.isDirty = true;
		}

		function Pong(board, players) {
			
			function updatePlayer(player) {
				// Determine if the player moved and by how much.
				var potential = 3;
				var delta = 0;
				if((player.keyState.up == 1) && (player.keyState.down == 0) && (player.top > 0)) {
					var distFromTop = player.top - 0;
					delta = (potential <= distFromTop ? potential : distFromTop) * -1;
					console.log(player.name + '(op=move, dir=up, req=' + potential + ', top=' + player.top + ', max=' + distFromTop + ', moved=' + delta + ')');
				} else if((player.keyState.down == 1) && (player.keyState.up == 0) && ((player.top + player.height) < boardHeight)) {
					var distFromBottom = boardHeight - (player.top + player.height);
					delta = (potential <= distFromBottom ? potential : distFromBottom);
					console.log(player.name + '(op=move, dir=down, req=' + potential + ', bottom=' + (player.top + player.height - 1) + ', max=' + distFromBottom + ', moved=' + delta + ')');
				}
				// Update the player's position.
				if(delta !== 0) {
					player.top += delta;
					player.isDirty = true;
				} else {
					player.isDirty = false;
				}
			}

			function drawPlayer(player, x0) {
				
				//if(player.isDirty) {
					//ctx.clearRect(x0, player.top - player.velocity, 10, player.height);
					ctx.fillRect(x0, player.top, 10, player.height);
				//}
			}

			function update() {
				updatePlayer(player1);
				updatePlayer(player2);
			}

			function render() {
				ctx.clearRect(0, 0, boardWidth, boardHeight);
				drawPlayer(player1, 1);
				drawPlayer(player2, 309);
			}

			this.run = function() {
				update();
				render();
			};

			var ctx = board.context;
			var boardWidth = board.width;
			var boardHeight = board.height;
			var player1 = players[0];
			var player2 = players[1];
			var that = this;
		}

		function getGameBoard(d, canvas_id) {
			var canvas = d.getElementById(canvas_id);
			if(!canvas) {
				console.error('Error: no canvas!!!');
				return;
			}
			if(!canvas.getContext) {
				console.error('Error: no canvas.getContext!!!');
				return;
			}
			var context = canvas.getContext('2d');
			if(!context) {
				console.error('Error: failed to canvas.getContext!!!');
				return;
			}
			return { 'width': canvas.width, 'height': canvas.height, 'context': context };
		}

		var ONE_FRAME_TIME = 1000 / 60;

		var pong = {};
		var input = { 'p1': { 'up': 0, 'down': 0 }, 'p2': { 'up': 0, 'down': 0 } };

		function autorun() {
			var board = getGameBoard(document, 'canvas');
			var players = [new Player('john', input.p1), new Player('chris', input.p2)];
			pong = new Pong(board, players);
			setInterval(pong.run, ONE_FRAME_TIME);
		}

		function onkey(e, val) {
			var keyCode = e.keyCode || e.charCode;
			switch(keyCode) {
				case 65:  // "a"
					input.p1.up = val;
					break;
				case 90:  // "z"
					input.p1.down = val;
					break;
				case 75:  // "k"
					input.p2.up = val;
					break;
				case 77: // "m"
					input.p2.down = val;
					break;
			}
		}
		function onkeydown(e) {
			onkey(e, 1);
		}
		function onkeyup(e) {
			onkey(e, 0);
		}

		
		/***** EVENT HOOKUPS *****/
		if (document.addEventListener) {
			document.addEventListener("DOMContentLoaded", autorun, false);
			document.addEventListener("keydown", onkeydown, false);
			document.addEventListener("keyup", onkeyup, false);
		} else if (document.attachEvent) {
			console.log("Ancient browser");
			document.attachEvent("onreadystatechange", autorun);
			//document.attachEvent("onkeydown", attachEvent_keydown);
			//document.attachEvent("onkeyup", attachEvent_keyup);
		} else {
			console.log("Prehistoric browser");
			window.onload = autorun;
			//window.onkeydown = onkeypress_keydown;
			//window.onkeyup = onkeypress_keyup;
		}
	</script>
	<script>
		var _gaq=[['_setAccount','UA-35929716-1'],['_trackPageview']];
		(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
		g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
		s.parentNode.insertBefore(g,s)}(document,'script'));
	</script>
</body>
</html>
